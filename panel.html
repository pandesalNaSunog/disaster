<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="panelstyle.css">
    <script>
        $(document).ready(function(){
            let loadingScreen = $('#loading-screen');
            let usersLink = $('#users-link');
            let navLink = $('.nav-link');
            let usersTable = $('#users-table');
            let usersSection = $('#users-section');
            let notifier = $('#notifier');
            let toastMessage = $('#toast-message');
            let feedLink = $('#feed-link');
            let feedSection = $('#feed-section');
            let postList = $('#post-list');

            navLink.on('click', function(){
                navLink.removeClass('active');
                $(this).addClass('active');
            })

            usersLink.on('click', function(){
                usersSection.show();
                feedSection.hide();
                getUsers();
            })
            feedLink.on('click', function(){
                usersSection.hide();
                feedSection.show();
                getPosts();
            })


            session();
            loadingScreen.hide();
            getUsers();

            feedSection.hide()




            function getPosts(){
                loadingScreen.show();
                postList.children().remove();

                $.ajax({
                    type: 'GET',
                    url: 'php/posts.php',
                    success: function(response){
                        loadingScreen.hide();
                        var data = JSON.parse(response);

                        $(data).each(function(index, value){
                            addToPostsList(index, value.id, value.user, value.caption, value.image, value.response, value.date);
                        })
                    }
                })
            }

            function addToPostsList(index, id, user, caption, image, response, date){
                postList.append(`<div class="text-light card col-lg-6 mx-auto mt-5 bg-dark rounded-3 shadow">
                                    <div class="card-header">
                                        <h4 class="fw-bold">${user.name}</h4>
                                        <span style="font-size: 12px"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar-event" viewBox="0 0 16 16">
                                            <path d="M11 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1z"/>
                                            <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
                                        </svg><span class="ms-2">${date}</span></span>
                                    </div>
                                    <div class="card-body">
                                        <p class="lead">${caption}</p>

                                        <img src="disasterapi/public/${image}" class="img-fluid">
                                        <div class="input-group mt-3" style="width: 100%">
                                            <button value="${id}" class="case-closed col btn btn-outline-success"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16">
                                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                                            </svg> Case Closed</button>
                                            <button value="${id}" class="crew-dispatched col btn btn-outline-primary"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16">
                                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                                            </svg> Crew Dispatched</button>
                                        </div>
                                    </div>
                                </div>`)

                let caseClosed = postList.children().eq(index).find('.case-closed');
                let crewDispatched = postList.children().eq(index).find('.crew-dispatched');


                if(response == 'case closed'){
                    caseClosed.removeClass('btn-outline-success');
                    caseClosed.addClass('btn-success');
                    crewDispatched.removeClass('btn-primary');
                    crewDispatched.addClass('btn-outline-primary');
                }else if(response == 'crew dispatched'){
                    caseClosed.removeClass('btn-success');
                    caseClosed.addClass('btn-outline-success');
                    crewDispatched.addClass('btn-primary');
                    crewDispatched.removeClass('btn-outline-primary');
                }
                
                caseClosed.on('click', function(){
                    var postId = $(this).val()
                    $.ajax({
                        type: 'POST',
                        url: 'php/updatePostResponse.php',
                        data:{
                            post_id: postId,
                            response: 'case closed'
                        },
                        success: function(response){
                            if(response == 'ok'){
                                caseClosed.removeClass('btn-outline-success');
                                caseClosed.addClass('btn-success');
                                crewDispatched.removeClass('btn-primary');
                                crewDispatched.addClass('btn-outline-primary');
                            }
                        }
                    })
                })

                crewDispatched.on('click', function(){
                    var postId = $(this).val()
                    $.ajax({
                        type: 'POST',
                        url: 'php/updatePostResponse.php',
                        data:{
                            post_id: postId,
                            response: 'crew dispatched'
                        },
                        success: function(response){
                            if(response == 'ok'){
                                caseClosed.removeClass('btn-success');
                                caseClosed.addClass('btn-outline-success');
                                crewDispatched.addClass('btn-primary');
                                crewDispatched.removeClass('btn-outline-primary');
                            }
                        }
                    })
                })
            }

            function getUsers(){
                loadingScreen.show()
                usersTable.children().remove();
                $.ajax({
                    type: 'GET',
                    url: 'php/users.php',
                    success: function(response){
                        loadingScreen.hide();
                        var data = JSON.parse(response);
                        $(data).each(function(index, value){
                            addToUsersTable(index, value.id, value.name, value.email, value.contact, value.address)
                        })
                    }
                })
            }

            function addToUsersTable(index, id, name, email, contact, address){
                usersTable.append(`<tr>
                                        <td>${name}</td>
                                        <td>${email}</td>
                                        <td>${contact}</td>
                                        <td>${address}</td>
                                        <td>
                                            <button value="${id}" class="delete-button btn btn-dark"><span class="progresser spinner-border spinner-border-sm"></span> Delete</button>
                                        </td>
                                    </tr>`)

                let deleteButton = usersTable.children().eq(index).find('.delete-button');
                let progress = usersTable.children().eq(index).find('.progresser');
                progress.hide();
                deleteButton.on('click', function(){
                    var thisDelete = $(this)
                    if(confirm('Delete this user?') == true){
                        progress.show()
                        deleteButton.prop('disabled', true);
                        var thisId = $(this).val()

                        $.ajax({
                            type: 'POST',
                            url: 'php/deleteUser.php',
                            data:{
                                user_id: thisId
                            },
                            success: function(response){
                                progress.hide();
                                deleteButton.prop('disabled', false);
                                if(response == 'ok'){
                                    notifier.toast('show');
                                    notifier.toast({delay: 5000});
                                    toastMessage.text('User has been deleted.')
                                    thisDelete.parent().parent().remove();
                                }
                            }
                        })
                    }
                })
            }
            function session(){
                $.ajax({
                    type: 'GET',
                    url: 'php/session.php',
                    success: function(response){
                        if(response != 'ok'){
                            window.location.replace(response)
                        }
                    }
                })
            }
        })
    </script>
    <title>Document</title>
</head>
<body>
    <nav class="sticky-top shadow navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <div class="navbar-brand">
                <h3 class="fw-bold">
                    Disaster
                </h3>
            </div>
            <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navmenu">
                <span class="navbar-toggler-icon">

                </span>
            </button>
            <div class="collapse navbar-collapse" id="navmenu">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a href="#" id="users-link" class="px-3 navigation-links nav-link active mx-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
                            <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                            <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                          </svg><span class="ms-3">Users</span></a>
                    </li>
                    <li class="nav-item">
                        <a href="#" id="feed-link" class="px-3 navigation-links nav-link mx-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-newspaper" viewBox="0 0 16 16">
                                <path d="M0 2.5A1.5 1.5 0 0 1 1.5 1h11A1.5 1.5 0 0 1 14 2.5v10.528c0 .3-.05.654-.238.972h.738a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 1 1 0v9a1.5 1.5 0 0 1-1.5 1.5H1.497A1.497 1.497 0 0 1 0 13.5v-11zM12 14c.37 0 .654-.211.853-.441.092-.106.147-.279.147-.531V2.5a.5.5 0 0 0-.5-.5h-11a.5.5 0 0 0-.5.5v11c0 .278.223.5.497.5H12z"/>
                                <path d="M2 3h10v2H2V3zm0 3h4v3H2V6zm0 4h4v1H2v-1zm0 2h4v1H2v-1zm5-6h2v1H7V6zm3 0h2v1h-2V6zM7 8h2v1H7V8zm3 0h2v1h-2V8zm-3 2h2v1H7v-1zm3 0h2v1h-2v-1zm-3 2h2v1H7v-1zm3 0h2v1h-2v-1z"/>
                              </svg><span class="ms-3">Reports</span></a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="px-3 navigation-links nav-link mx-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear-fill" viewBox="0 0 16 16">
                                <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/>
                              </svg><span class="ms-3">Settings</span></a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>


    <section id="users-section">
        <div class="container">
            <div class="card bg-dark rounded-3 shadow mt-5">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-dark">
                            <thead>
                                <th scope="col">Name</th>
                                <th scope="col">Email</th>
                                <th scope="col">Contact Number</th>
                                <th scope="col">Address</th>
                                <th scope="col">Actions</th>
                            </thead>
                            <tbody id="users-table">
    
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <div id="loading-screen" style="background-color: rgba(0,0,0,0.5);width: 100%; height: 100vh;position: fixed;top:0; left:0; display: flex; justify-content:center; align-items: center;">
        <div class="card rounded-3">
            <div class="card-body text-center">
                <div class="spinner-border text-dark">

                </div>
                <p>Please Wait...</p>
            </div>
        </div>
    </div>

    <div class="toast-container bottom-0 end-0 m-5">
        <div class="toast" id="notifier">
            <div class="toast-body">
                <span class="fw-bold" id="toast-message"></span>
            </div>
        </div>
    </div>

    <section id="feed-section">
        <div class="container">
            <div id="post-list">

            </div>
            
        </div>
    </section>
    
</body>
</html>